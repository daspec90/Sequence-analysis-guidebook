---
title: "DAT Screen Next Generation Sequencing"
author: "Dave Speca"
date: "5/31/2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

| Sequence | Compressed | File Size | Number of reads | Source     | bam   |
| :------: | :--------: | :-------: | :-------------: | :----:     | :---: |
| Chr2R1   |            |  14 Gb    | 42,117,483      | Tail       | 33 Gb |
| Chr2R2   |            |  14 Gb    | 42,117,483      | Tail       |       |
| Chr16R1  | 14 Gb     | 41,324,213      | Tail (low) |
| Chr16R2  | 14 Gb     | 41,324,213      | Tail (low) |
| Chr18R1  | 15 Gb     | 45,940,146      | Tail       |
| Chr18R2  | 15 Gb     | 45,940,146      | Tail       |
| D2R1     | 3.3 Gb    | 15 Gb     | 44,904,397      | Liver      | 35 Gb |
| D2R2     | 3.5 Gb    | 15 Gb     | 44,904,397      | Liver      |       |

##DNA sequence analysis pipeline:
* Download using Globus
* gunzip files
* make alias:  `ln -s long_file_name.fastq shorter_name.fastq`
* count lines in file: `wc -l shorter_name.fastq`
* calculate the % of one mismatch barcodes in each file

N.B. the number of lines divided by four was equal to the reported total number of reads for all downloaded files. For Chr16, it was ~4%; all others it was ~3%

###Fastqc
* subset a smaller set of sequence data for fastqc analysis: `awk 'NR >250000 {exit} NR >=1 && NR <=250000' shorter_name.fastq > small.fastq`
* to determine the size of an individual file type: `du -h filename`

Note that the maximum attachment size for Gmail is 25 Mb. These file sizes are ~21 Mb.
Note that `du`, which stands for "disk usage" will report a different file size than `ls`.

The fastqc reports looked very similar, indicating reads of high quality. The following items were flagged:
1. "per base sequence content" at the very end of the reads. UCLA looked at the report and explained that this was because A's were trimmed in the process of removing adapter sequences. Illumina libraries use an A-tailing technique. Removal of A's near the end of the sequence is a conservative approach. No need for further processing.
2. "Kmer content" at the beginning of the sequence. Not a problem either. This is also a consequence of how Illumina libraries are made. There is a random priming step, but the annealling of the primers is not random. But UCLA said that this should not be a problem.

###Injury prevention

Illumina Reads 1 and 2 are arranged in the same order. Downstream alignment software that pairs these reads makes this assumption. Therefore, care must be taken to prune the sequence(s) of both files in the same way. To prevent screwups, Julin recommended that I write-protect the original fastq files using `chmod u-w filename.fastq`, which is what I did.

###Homebrew and bwa installation

I installed Homebrew (a Mac package manager) using this command:

`/usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"`

then, to install bwa:

`brew tap homebrew/science`
`brew install bwa`
`bwa` # this brought up the reference manual, indicating proper installation.

###Download mouse reference sequence

`brew install wget`

`wget http://hgdownload.cse.ucsc.edu/goldenPath/mm10/bigZips/chromFa.tar.gz`

During the download, data transfer stopped completely for some reason. Instead of starting over, I did this:

Press `control` + `c` to stop the process and then added -c to the above command:

`wget -c http://hgdownload.cse.ucsc.edu/goldenPath/mm10/bigZips/chromFa.tar.gz`

This seemed to pick up where things left off, I hope.

This tarball came as a file of individual chromosomes. We need to unzip them, concatenate them, and then get rid of the individual chromosome files:

`tar zvfx chromFa.tar.gz`
`cat *.fa > mm10.fa`
`rm chr*.fa`

###bwa

Make index:
`bwa index mm10.fa`

Indexing took about 45 minutes to run.

`bwa mem -t 4 mm10.fa DBAR1.fastq DBAR2.fastq > DBA.sam`

Aligning took about 90 minutes to run, using -t 4 (cores), which consumed about 50% of the available CPU (although it was running at ~400%).

###samtools

`brew install samtools`

Convert .sam to .bam:
`samtools view -S -b DBA.sam > DBA.bam`

Converting to .bam took ~30 minutes

Sort .bam:
`samtools sort DBA.bam -o DBA.sort.bam`

